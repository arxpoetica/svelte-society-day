<!-- bind:currentTime -->
<!-- bind:duration -->
<audio
	{src}
	bind:this={audio}
	bind:volume={indirect_volume}
	bind:paused
	use:lazy
	loop
	type="audio/mp3"
>
</audio>

<script>
	// export let threshold
	// let duration
	// $: currentTime = duration * threshold

	export let intersecting
	export let src
	export let volume = 1

	// import { muted } from '../../stores/story-store.js'
	import { tweened } from 'svelte/motion'
	import { cubicIn, cubicOut } from 'svelte/easing'

	let audio
	let loaded = false

	let volume_tween = tweened(0, { duration: 1000 })

	$: paused = !(loaded && intersecting) && $volume_tween === 0
	// // $: if (loaded) { audio.muted = $muted; }

	// NOTE: bug?
	$: indirect_volume = $volume_tween
	$: if (loaded) {
		intersecting ? tween(volume, cubicIn) : tween(0, cubicOut)
	}
	async function tween(to, easing) {
		await volume_tween.set(to, { easing })
	}

	function lazy(audio) {
		audio.oncanplaythrough = () => loaded = true
		return { destroy() {} } // noop
	}
</script>

<style type="text/scss">
	audio { pointer-events: none; }
</style>
